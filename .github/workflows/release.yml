name: Build & Release - Multi-Platform (Nuitka Compiled)

on:
  push:
    branches:
      - main
    tags:
      - 'v*.*.*'
  workflow_dispatch:  # Allow manual triggering

env:
  PYTHON_VERSION: '3.12'
  APP_NAME: 'OA-OrientationAutomator'

jobs:
  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install audit tools
        run: |
          python -m pip install --upgrade pip
          pip install pip-audit safety

      - name: Run pip-audit (2025 vulnerability check)
        run: |
          # Audit requirements files without installing (faster and safer)
          if [ -f "requirements.txt" ]; then
            pip-audit --requirement requirements.txt --desc || echo "requirements.txt audit complete"
          else
            echo "⚠️ requirements.txt not found, skipping audit"
          fi
          
          if [ -f "requirements-security.txt" ]; then
            pip-audit --requirement requirements-security.txt --desc || echo "requirements-security.txt audit complete"
          else
            echo "⚠️ requirements-security.txt not found, skipping audit"
          fi
        continue-on-error: false  # Fail if vulnerabilities found

      - name: Run safety check
        run: |
          safety check --json
        continue-on-error: true  # Warning only

      - name: Verify no hardcoded secrets
        run: |
          echo "Scanning for hardcoded secrets..."
          
          # Check for OpenAI-style API keys (sk-...)
          if grep -r "sk-[a-zA-Z0-9]" src/ 2>/dev/null; then
            echo "ERROR: Potential hardcoded API key found!"
            exit 1
          fi
          
          # Check for hardcoded API keys, but exclude safe patterns
          # Safe patterns: os.getenv(), os.environ.get(), config.get()
          if grep -r "api_key.*=.*['\"][^'\"]\+" src/ 2>/dev/null | \
             grep -v "os\.getenv" | \
             grep -v "os\.environ" | \
             grep -v "config\.get" | \
             grep -v "\.get(" | \
             grep -v "api_key.*=.*['\"]['\"]" | \
             grep -q .; then
            echo "ERROR: Hardcoded API key found!"
            echo "Found:"
            grep -r "api_key.*=.*['\"][^'\"]\+" src/ | \
              grep -v "os\.getenv" | \
              grep -v "os\.environ" | \
              grep -v "config\.get" | \
              grep -v "\.get(" | \
              grep -v "api_key.*=.*['\"]['\"]"
            exit 1
          fi
          
          echo "✓ No hardcoded secrets found"

  build-compiled:
    name: Build ${{ matrix.os }}
    needs: security-audit
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [windows-latest, macos-latest, ubuntu-latest]
        include:
          - os: windows-latest
            binary_name: OA-OrientationAutomator.exe
            artifact_name: windows-x64
          - os: macos-latest
            binary_name: OA-OrientationAutomator
            artifact_name: macos-universal
          - os: ubuntu-latest
            binary_name: OA-OrientationAutomator
            artifact_name: linux-x64

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv (fast dependency manager)
        run: |
          python -m pip install --upgrade pip
          pip install uv
        shell: bash

      - name: Install dependencies with uv
        run: |
          # Install main requirements
          if [ -f "requirements.txt" ]; then
            uv pip install --system -r requirements.txt
          else
            echo "⚠️ requirements.txt not found, installing from pyproject.toml"
            uv pip install --system PySide6 requests platformdirs python-dotenv cryptography
          fi
          
          # Install security requirements if present
          if [ -f "requirements-security.txt" ]; then
            uv pip install --system -r requirements-security.txt
          fi
        shell: bash

      - name: Install Nuitka
        run: |
          pip install nuitka ordered-set zstandard imageio
        shell: bash

      - name: Install Platform-Specific Build Tools
        run: |
          if [ "${{ matrix.os }}" == "ubuntu-latest" ]; then
            sudo apt-get update
            sudo apt-get install -y ccache patchelf
          elif [ "${{ matrix.os }}" == "macos-latest" ]; then
            brew install ccache
          fi
        shell: bash

      - name: Create build metadata
        run: |
          echo "Build Date: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" > BUILD_INFO.txt
          echo "Platform: ${{ matrix.os }}" >> BUILD_INFO.txt
          echo "Python: ${{ env.PYTHON_VERSION }}" >> BUILD_INFO.txt
          echo "Commit: ${{ github.sha }}" >> BUILD_INFO.txt
          echo "Branch: ${{ github.ref_name }}" >> BUILD_INFO.txt
        shell: bash

      - name: Compile with Nuitka (GUI)
        run: |
          echo "Starting Nuitka compilation..."
          
          # Platform-specific Nuitka options (only add icon if file exists)
          NUITKA_EXTRA=""
          if [ "${{ matrix.os }}" == "windows-latest" ]; then
            NUITKA_EXTRA="--windows-console-mode=disable"
            if [ -f "assets/icon.ico" ]; then
              NUITKA_EXTRA="$NUITKA_EXTRA --windows-icon-from-ico=assets/icon.ico"
            else
              echo "⚠️ assets/icon.ico not found, skipping icon"
            fi
          elif [ "${{ matrix.os }}" == "macos-latest" ]; then
            # Note: --onefile creates .bin, not .app bundle
            # Icon is embedded in the binary when using --macos-app-icon
            # Let Nuitka convert PNG to ICNS (more reliable than using pre-made ICNS)
            if [ -f "assets/icon.png" ]; then
              NUITKA_EXTRA="--macos-app-icon=assets/icon.png"
              echo "✓ Using icon: assets/icon.png (Nuitka will convert to ICNS automatically)"
            elif [ -f "assets/icon.icns" ]; then
              NUITKA_EXTRA="--macos-app-icon=assets/icon.icns"
              echo "✓ Using icon: assets/icon.icns (fallback, embedded in binary)"
            else
              echo "⚠️ No icon file found (checked icon.png and icon.icns), skipping icon"
            fi
          else
            if [ -f "assets/icon.png" ]; then
              NUITKA_EXTRA="--linux-icon=assets/icon.png"
            else
              echo "⚠️ assets/icon.png not found, skipping icon"
            fi
          fi
          
          # Compile GUI application with auto-approve downloads
          python -m nuitka \
            --standalone \
            --onefile \
            --enable-plugin=pyside6 \
            --include-package=src \
            --include-package=dotenv \
            --include-package=platformdirs \
            --include-data-files=config.json=config.json \
            --include-data-files=env.example=env.example \
            --noinclude-pytest-mode=nofollow \
            --noinclude-setuptools-mode=nofollow \
            --assume-yes-for-downloads \
            --output-dir=dist \
            --output-filename=${{ matrix.binary_name }} \
            $NUITKA_EXTRA \
            gui_new.py || {
              echo "⚠️ Nuitka compilation with advanced options failed, trying basic compilation..."
              python -m nuitka \
                --standalone \
                --onefile \
                --enable-plugin=pyside6 \
                --include-package=src \
                --include-package=dotenv \
                --include-package=platformdirs \
                --assume-yes-for-downloads \
                --output-dir=dist \
                --output-filename=${{ matrix.binary_name }} \
                gui_new.py
            }
          
          echo "✓ Nuitka compilation complete"
        shell: bash

      - name: Verify compilation
        id: verify-binary
        run: |
          echo "Verifying compiled binary..."
          ls -lh dist/
          
          # Check that binary was created (Nuitka creates .bin on macOS with --onefile)
          if [ "${{ matrix.os }}" == "windows-latest" ]; then
            BINARY_PATH="dist/${{ matrix.binary_name }}"
          elif [ "${{ matrix.os }}" == "macos-latest" ]; then
            # Nuitka with --onefile creates .bin file, not .app bundle
            # Check multiple possible locations/names
            if [ -f "dist/${{ matrix.binary_name }}.bin" ]; then
              BINARY_PATH="dist/${{ matrix.binary_name }}.bin"
            elif [ -f "dist/${{ matrix.binary_name }}" ]; then
              BINARY_PATH="dist/${{ matrix.binary_name }}"
            elif [ -f "dist/${{ matrix.binary_name }}.dist/${{ matrix.binary_name }}" ]; then
              BINARY_PATH="dist/${{ matrix.binary_name }}.dist/${{ matrix.binary_name }}"
            else
              # Try to find any binary in dist/
              BINARY_PATH=$(find dist -type f -name "${{ matrix.binary_name }}*" -perm +111 2>/dev/null | head -1)
              if [ -z "$BINARY_PATH" ]; then
                BINARY_PATH="dist/${{ matrix.binary_name }}.bin"
              fi
            fi
          else
            BINARY_PATH="dist/${{ matrix.binary_name }}"
          fi
          
          if [ -e "$BINARY_PATH" ]; then
            echo "✓ Binary created successfully: $BINARY_PATH"
            ls -lh "$BINARY_PATH"
            # Note: With --onefile, Nuitka creates a .bin file, not an .app bundle
            # Icon is embedded via --macos-app-icon flag during compilation
            if [ "${{ matrix.os }}" == "macos-latest" ] && [ -f "$BINARY_PATH" ]; then
              echo "ℹ️ macOS binary created as .bin file"
              echo "ℹ️ Icon should be embedded via --macos-app-icon flag (set during compilation)"
              echo "ℹ️ To set icon manually after download, use: fileicon set <binary> <icon.icns>"
            fi
            echo "binary_path=$BINARY_PATH" >> $GITHUB_OUTPUT
          else
            echo "ERROR: Binary not found at $BINARY_PATH"
            echo "Listing dist/ directory contents:"
            ls -lah dist/ || true
            echo "binary_path=" >> $GITHUB_OUTPUT
            exit 1
          fi
        shell: bash

      - name: Alternative packaging (if Nuitka fails)
        if: failure()
        run: |
          echo "Nuitka compilation failed, creating PyInstaller binary as fallback..."
          
          pip install pyinstaller
          
          # Build with PyInstaller
          pyinstaller gui_new.py \
            --name ${{ matrix.binary_name }} \
            --onefile \
            --windowed \
            --add-data "config.json:." \
            --add-data "env.example:." \
            --add-data "src:src" \
            --hidden-import=PySide6 \
            --hidden-import=cryptography \
            --hidden-import=dotenv \
            --clean \
            --noconfirm
          
          # Move binary
          if [ -f "dist/${{ matrix.binary_name }}" ]; then
            mv "dist/${{ matrix.binary_name }}" "../${{ matrix.binary_name }}"
            echo "✓ PyInstaller binary created"
          fi
        shell: bash

      - name: Sign binary (macOS only)
        if: matrix.os == 'macos-latest'
        run: |
          # Note: Requires Apple Developer account and certificates
          # For now, we'll just note that signing should be done
          echo "Note: macOS binary should be signed with:"
          echo "  codesign --force --sign <identity> dist/${{ matrix.binary_name }}"
          echo "  codesign --verify --verbose dist/${{ matrix.binary_name }}"
        shell: bash

      - name: Create distribution package
        run: |
          echo "Creating distribution package..."
          
          mkdir -p release/${{ matrix.artifact_name }}
          
          # Copy binary (Nuitka creates .bin on macOS with --onefile)
          if [ "${{ matrix.os }}" == "macos-latest" ]; then
            if [ -f "dist/${{ matrix.binary_name }}.bin" ]; then
              cp "dist/${{ matrix.binary_name }}.bin" "release/${{ matrix.artifact_name }}/"
            elif [ -f "dist/${{ matrix.binary_name }}" ]; then
              cp "dist/${{ matrix.binary_name }}" "release/${{ matrix.artifact_name }}/"
            fi
          elif [ -f "dist/${{ matrix.binary_name }}" ]; then
            cp "dist/${{ matrix.binary_name }}" "release/${{ matrix.artifact_name }}/"
          fi
          
          # Copy documentation
          cp BUILD_INFO.txt release/${{ matrix.artifact_name }}/
          cp README*.md release/${{ matrix.artifact_name }}/ 2>/dev/null || true
          cp SECURITY*.md release/${{ matrix.artifact_name }}/ 2>/dev/null || true
          cp env.example release/${{ matrix.artifact_name }}/
          
          # Create README for distribution
          cat > release/${{ matrix.artifact_name }}/README.txt << 'EOF'
          OA - Orientation Automator
          ===========================
          
          This is a compiled binary distribution (Nuitka).
          
          SECURITY NOTES:
          - Code is compiled to machine code (not Python bytecode)
          - Native performance with strong protection
          - For configuration, copy env.example to .env and edit
          
          USAGE:
          1. Copy env.example to .env
          2. Edit .env with your API keys (if needed)
          3. Run the binary
          
          For more information, see the included documentation.
          EOF
          
          # Create archive
          cd release
          if [ "${{ matrix.os }}" == "windows-latest" ]; then
            7z a -tzip "${{ matrix.artifact_name }}.zip" "${{ matrix.artifact_name }}/"
          else
            tar -czf "${{ matrix.artifact_name }}.tar.gz" "${{ matrix.artifact_name }}/"
          fi
          cd ..
          
          echo "✓ Distribution package created"
        shell: bash

      - name: Generate checksums
        run: |
          cd release
          if [ "${{ matrix.os }}" == "windows-latest" ]; then
            certutil -hashfile "${{ matrix.artifact_name }}.zip" SHA256 > "${{ matrix.artifact_name }}.zip.sha256"
          else
            shasum -a 256 "${{ matrix.artifact_name }}.tar.gz" > "${{ matrix.artifact_name }}.tar.gz.sha256"
          fi
          cd ..
        shell: bash

      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}-binary
          path: ${{ steps.verify-binary.outputs.binary_path }}
          if-no-files-found: warn

      - name: Upload distribution package
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}-package
          path: |
            release/${{ matrix.artifact_name }}.*
          if-no-files-found: error

      - name: Upload to release (on tag)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            release/${{ matrix.artifact_name }}.*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  create-release-notes:
    name: Create Release Notes
    needs: build-compiled
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate release notes
        run: |
          cat > RELEASE_NOTES.md << 'EOF'
          # OA - Orientation Automator Release
          
          ## Security Features
          - ✅ Compiled with Nuitka (Python → C → Machine Code)
          - ✅ Native performance with strong protection
          - ✅ Standalone binaries (no Python required)
          - ✅ All dependencies bundled
          - ✅ Security-hardened (2025 standards)
          
          ## Platforms
          - Windows x64
          - macOS Universal
          - Linux x64
          
          ## Installation
          1. Download the package for your platform
          2. Extract the archive
          3. Copy `env.example` to `.env` and configure
          4. Run the binary
          
          ## Checksums
          Verify your download with the included .sha256 files.
          
          ## Notes
          - This is a compiled distribution (Nuitka)
          - Native machine code (not Python bytecode)
          - For security, secrets must be in `.env` file
          EOF
          
          cat RELEASE_NOTES.md

      - name: Update release with notes
        uses: softprops/action-gh-release@v1
        with:
          body_path: RELEASE_NOTES.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

